import telebot
from telebot import types
import sqlite3
import threading
import json
import re

# --- 1. CONFIGURATION ---
TOKEN = '8530425100:AAFVgS2x9v9Bwct7TzNwxFYa_CZ7KdMqmfs'
ADMIN_IDS = [5146625949, 7834267436]
# ---------------------


# --- 2. DATABASE FUNCTIONS (REWORKED FOR STABILITY) ---

db_local = threading.local()

def get_db_conn():
    if not hasattr(db_local, 'conn'):
        db_local.conn = sqlite3.connect('streeteda.db', check_same_thread=False)
    return db_local.conn

def db_query(query, params=(), fetchone=False, commit=False):
    conn = get_db_conn()
    cursor = conn.cursor()
    cursor.execute(query, params)
    result = None
    if commit:
        conn.commit()
    elif fetchone:
        result = cursor.fetchone()
    else:
        result = cursor.fetchall()
    return result

def populate_db(cursor):
    cursor.execute("SELECT COUNT(*) FROM categories")
    if cursor.fetchone()[0] > 0:
        print("Database already populated. Skipping.")
        return
    print("Populating database with initial menu data...")
    categories_to_add = [('Ð¨Ð°ÑÑÐ¼Ð°',), ('ÐÑÐ»Ñ-ÐºÐµÐ±Ð°Ð±',), ('ÐÐ°ÑÐ½Ð¸ÑÑ',), ('ÐÐ¾Ð±Ð°Ð²ÐºÐ¸',), ('ÐÑÑÐ³Ð¾Ðµ',)]
    cursor.executemany("INSERT INTO categories (name) VALUES (?)", categories_to_add)
    cursor.execute("SELECT id, name FROM categories")
    cat_map = {name: id for id, name in cursor.fetchall()}
    items_to_add = [
        ('Ð¡ÑÐ°Ð½Ð´Ð°ÑÑÐ½Ð°Ñ (400 Ð³ÑÐ°Ð¼Ð¼)', 'ÐÐ»Ð°ÑÑÐ¸ÑÐµÑÐºÐ°Ñ ÑÐ°ÑÑÐ¼Ð°', 230, cat_map['Ð¨Ð°ÑÑÐ¼Ð°']), ('ÐÐ¸Ð½Ð¸ (300 Ð³ÑÐ°Ð¼Ð¼)', 'Ð£Ð¼ÐµÐ½ÑÑÐµÐ½Ð½Ð°Ñ Ð¿Ð¾ÑÑÐ¸Ñ ÐºÐ»Ð°ÑÑÐ¸ÐºÐ¸', 200, cat_map['Ð¨Ð°ÑÑÐ¼Ð°']), ('Ð¡ÑÑÐ½Ð°Ñ ÑÐ°ÑÑÐ¼Ð° (500 Ð³ÑÐ°Ð¼Ð¼)', 'Ð¨Ð°ÑÑÐ¼Ð° Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ ÑÑÑÐ°', 250, cat_map['Ð¨Ð°ÑÑÐ¼Ð°']), ('ÐÐ°ÑÐ±ÐµÐºÑ ÑÐ°ÑÑÐ¼Ð° (500 Ð³ÑÐ°Ð¼Ð¼)', 'Ð¡ ÑÐ¸ÑÐ¼ÐµÐ½Ð½ÑÐ¼ ÑÐ¾ÑÑÐ¾Ð¼ Ð±Ð°ÑÐ±ÐµÐºÑ', 250, cat_map['Ð¨Ð°ÑÑÐ¼Ð°']), ('ÐÑÐ°Ð½Ð°ÑÐ¾Ð²Ð°Ñ ÑÐ°ÑÑÐ¼Ð° (500 Ð³ÑÐ°Ð¼Ð¼)', 'Ð¡ Ð¿Ð¸ÐºÐ°Ð½ÑÐ½ÑÐ¼ Ð³ÑÐ°Ð½Ð°ÑÐ¾Ð²ÑÐ¼ ÑÐ¾ÑÑÐ¾Ð¼', 250, cat_map['Ð¨Ð°ÑÑÐ¼Ð°']), ('ÐÐ¾-Ð¼ÐµÐºÑÐ¸ÐºÐ°Ð½ÑÐºÐ¸ ÑÐ°ÑÑÐ¼Ð° (500 Ð³ÑÐ°Ð¼Ð¼)', 'ÐÑÑÑÐ°Ñ ÑÐ°ÑÑÐ¼Ð° Ñ ÑÐ°Ð»Ð°Ð¿ÐµÐ½ÑÐ¾', 250, cat_map['Ð¨Ð°ÑÑÐ¼Ð°']), ('Ð¥Ð¥Ð ÑÐ°ÑÑÐ¼Ð° (600 Ð³ÑÐ°Ð¼Ð¼)', 'ÐÐ³ÑÐ¾Ð¼Ð½Ð°Ñ Ð¸ ÑÑÑÐ½Ð°Ñ', 290, cat_map['Ð¨Ð°ÑÑÐ¼Ð°']), ('Ð¨Ð°ÑÑÐ¼Ð° Ð±ÐµÐ· Ð¼ÑÑÐ° (ÐÐµÐ³Ð°Ð½)', 'Ð¡Ð²ÐµÐ¶Ð¸Ðµ Ð¾Ð²Ð¾ÑÐ¸ Ð¸ ÑÐ¾ÑÑ Ð² Ð»Ð°Ð²Ð°ÑÐµ', 180, cat_map['Ð¨Ð°ÑÑÐ¼Ð°']), ('ÐÐ¸ÑÐ¾ (500 Ð³ÑÐ°Ð¼Ð¼)', 'ÐÑÐµÑÐµÑÐºÐ°Ñ ÑÐ°ÑÑÐ¼Ð° Ñ ÐºÐ°ÑÑÐ¾ÑÐµÐ»ÐµÐ¼ ÑÑÐ¸ Ð²Ð½ÑÑÑÐ¸', 250, cat_map['Ð¨Ð°ÑÑÐ¼Ð°']), ('Ð¡Ð¾ÑÐ¸ÑÐºÐ° Ð² Ð»Ð°Ð²Ð°ÑÐµ', 'Ð¡Ð¾ÑÐ¸ÑÐºÐ° Ñ Ð¾Ð²Ð¾ÑÐ°Ð¼Ð¸ Ð¸ ÑÐ¾ÑÑÐ¾Ð¼', 170, cat_map['Ð¨Ð°ÑÑÐ¼Ð°']), ('Ð¨Ð°ÑÑÐ¼Ð° Ñ Ð½Ð°Ð³Ð³ÐµÑÑÐ°Ð¼Ð¸', 'Ð¨Ð°ÑÑÐ¼Ð° Ñ ÐºÑÑÐ¸Ð½ÑÐ¼Ð¸ Ð½Ð°Ð³Ð³ÐµÑÑÐ°Ð¼Ð¸', 270, cat_map['Ð¨Ð°ÑÑÐ¼Ð°']), ('ÐÑÐ»Ñ-ÐºÐµÐ±Ð°Ð± Ð¸Ð· ÑÐ²Ð¸Ð½Ð¸Ð½Ñ Ð² Ð»Ð°Ð²Ð°ÑÐµ', None, 300, cat_map['ÐÑÐ»Ñ-ÐºÐµÐ±Ð°Ð±']), ('ÐÑÐ»Ñ-ÐºÐµÐ±Ð°Ð± Ð¸Ð· Ð³Ð¾Ð²ÑÐ´Ð¸Ð½Ñ Ð² Ð»Ð°Ð²Ð°ÑÐµ', None, 300, cat_map['ÐÑÐ»Ñ-ÐºÐµÐ±Ð°Ð±']), ('ÐÐ°ÑÑÐ¾ÑÐµÐ»Ñ ÑÑÐ¸ (100 Ð³Ñ)', 'ÐÐ»Ð°ÑÑÐ¸ÑÐµÑÐºÐ¸Ð¹ ÐºÐ°ÑÑÐ¾ÑÐµÐ»Ñ ÑÑÐ¸', 100, cat_map['ÐÐ°ÑÐ½Ð¸ÑÑ']), ('ÐÐ°ÑÑÐ¾ÑÐµÐ»Ñ Ð¿Ð¾-Ð´ÐµÑÐµÐ²ÐµÐ½ÑÐºÐ¸ (100 Ð³Ñ)', 'ÐÐ¿Ð¿ÐµÑÐ¸ÑÐ½ÑÐµ Ð´Ð¾Ð»ÑÐºÐ¸ ÐºÐ°ÑÑÐ¾ÑÐµÐ»Ñ', 100, cat_map['ÐÐ°ÑÐ½Ð¸ÑÑ']), ('ÐÐ°Ð³Ð³ÐµÑÑÑ (5 ÑÑ)', 'ÐÑÑÐ¸Ð½ÑÐµ Ð½Ð°Ð³Ð³ÐµÑÑÑ', 100, cat_map['ÐÐ°ÑÐ½Ð¸ÑÑ']), ('ÐÑÑÐ³ÐµÑ-Ð¥Ð¸Ñ', 'ÐÐ°Ñ ÑÐ¸ÑÐ¼ÐµÐ½Ð½ÑÐ¹ Ð±ÑÑÐ³ÐµÑ', 300, cat_map['ÐÑÑÐ³Ð¾Ðµ']), ('ÐÐ¾Ð¿. ÐÐ°ÑÑÐ¾ÑÐµÐ»Ñ ÑÑÐ¸', None, 30, cat_map['ÐÐ¾Ð±Ð°Ð²ÐºÐ¸']), ('ÐÐ¾Ð¿. ÐÐ³ÑÑÑÑ ÑÐ¾Ð»ÐµÐ½ÑÐµ', None, 30, cat_map['ÐÐ¾Ð±Ð°Ð²ÐºÐ¸']), ('ÐÐ¾Ð¿. Ð¡ÑÑ', None, 30, cat_map['ÐÐ¾Ð±Ð°Ð²ÐºÐ¸']), ('ÐÐ¾Ð¿. Ð¥Ð°Ð»Ð°Ð¿ÐµÐ½ÑÐ¾', None, 30, cat_map['ÐÐ¾Ð±Ð°Ð²ÐºÐ¸']), ('ÐÐ¾Ð¿. ÐÑÑÐ¾', None, 70, cat_map['ÐÐ¾Ð±Ð°Ð²ÐºÐ¸']), ('ÐÐ¾Ð¿. Ð¡Ð¾ÑÐ¸ÑÐºÐ°', None, 40, cat_map['ÐÐ¾Ð±Ð°Ð²ÐºÐ¸']),
    ]
    cursor.executemany("INSERT INTO menu_items (name, description, price, category_id) VALUES (?, ?, ?, ?)", items_to_add)
    print("Database population complete.")

def init_db():
    conn = get_db_conn()
    cursor = conn.cursor()
    cursor.execute('CREATE TABLE IF NOT EXISTS admins (user_id INTEGER PRIMARY KEY)')
    cursor.execute('CREATE TABLE IF NOT EXISTS categories (id INTEGER PRIMARY KEY, name TEXT UNIQUE NOT NULL)')
    cursor.execute('''CREATE TABLE IF NOT EXISTS menu_items (id INTEGER PRIMARY KEY, name TEXT NOT NULL,
                      description TEXT, price REAL NOT NULL, photo_id TEXT, category_id INTEGER,
                      FOREIGN KEY (category_id) REFERENCES categories (id))''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS cart (user_id INTEGER, item_id INTEGER, quantity INTEGER,
                      PRIMARY KEY (user_id, item_id), FOREIGN KEY (item_id) REFERENCES menu_items (id))''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS orders (id INTEGER PRIMARY KEY, user_id INTEGER, user_name TEXT,
                      phone_number TEXT, delivery_type TEXT, address TEXT, comment TEXT, total_amount REAL,
                      status TEXT DEFAULT 'new', created_at DATETIME DEFAULT CURRENT_TIMESTAMP)''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS order_items (id INTEGER PRIMARY KEY, order_id INTEGER, item_name TEXT,
                      quantity INTEGER, price_per_item REAL, FOREIGN KEY (order_id) REFERENCES orders (id))''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS user_states (user_id INTEGER PRIMARY KEY, state TEXT, data TEXT)''')
    cursor.execute('CREATE TABLE IF NOT EXISTS settings (key TEXT PRIMARY KEY, value REAL)')
    
    for admin_id in ADMIN_IDS:
        cursor.execute("INSERT OR IGNORE INTO admins (user_id) VALUES (?)", (admin_id,))
    
    cursor.execute("INSERT OR IGNORE INTO settings (key, value) VALUES ('delivery_fee', 400)")
    cursor.execute("INSERT OR IGNORE INTO settings (key, value) VALUES ('free_delivery_threshold', 1000)")
    
    populate_db(cursor)
    conn.commit()


# --- 3. STATE & SETTINGS MANAGEMENT FUNCTIONS ---

def set_user_state(user_id, state, data=None):
    json_data = json.dumps(data) if data else None
    db_query("INSERT OR REPLACE INTO user_states (user_id, state, data) VALUES (?, ?, ?)", 
             (user_id, state, json_data), commit=True)

def get_user_state(user_id):
    result = db_query("SELECT state, data FROM user_states WHERE user_id = ?", (user_id,), fetchone=True)
    if result:
        state, json_data = result
        data = json.loads(json_data) if json_data else {}
        return state, data
    return None, {}

def clear_user_state(user_id):
    db_query("DELETE FROM user_states WHERE user_id = ?", (user_id,), commit=True)

def get_settings():
    settings_list = db_query("SELECT key, value FROM settings")
    return {key: value for key, value in settings_list}


# --- 4. BOT INITIALIZATION ---
bot = Bot(token=API_TOKEN)
init_db()


# --- 5. UI & LOGIC FUNCTIONS ---

def get_main_menu_keyboard():
    """Ð¡Ð¾Ð·Ð´Ð°ÐµÑ Ð¸ Ð²Ð¾Ð·Ð²ÑÐ°ÑÐ°ÐµÑ Ð³Ð»Ð°Ð²Ð½ÑÑ Ð¿Ð¾ÑÑÐ¾ÑÐ½Ð½ÑÑ ÐºÐ»Ð°Ð²Ð¸Ð°ÑÑÑÑ."""
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add(types.KeyboardButton("ð´ ÐÐµÐ½Ñ"))
    return markup

def show_categories(chat_id, message_id=None):
    categories = db_query("SELECT id, name FROM categories ORDER BY id")
    markup = types.InlineKeyboardMarkup(row_width=2)
    buttons = [types.InlineKeyboardButton(cat[1], callback_data=f'category:{cat[0]}') for cat in categories]
    markup.add(*buttons)
    markup.add(types.InlineKeyboardButton("ð ÐÐ¾ÑÐ·Ð¸Ð½Ð°", callback_data='view_cart'))
    text = "ð ÐÑÐ±ÐµÑÐ¸ÑÐµ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ñ:"
    try:
        if message_id:
            bot.edit_message_text(text, chat_id, message_id, reply_markup=markup)
        else:
            bot.send_message(chat_id, text, reply_markup=markup)
    except telebot.apihelper.ApiTelegramException as e:
        if "message is not modified" not in str(e): print(f"Error editing message: {e}")

def show_items_in_category(chat_id, message_id, category_id):
    items = db_query("SELECT id, name, price FROM menu_items WHERE category_id = ? ORDER BY name", (category_id,))
    markup = types.InlineKeyboardMarkup(row_width=1)
    for item_id, name, price in items:
        markup.add(types.InlineKeyboardButton(f"{name} - {int(price)} ÑÑÐ±.", callback_data=f'item:{item_id}'))
    markup.add(types.InlineKeyboardButton("â¬ï¸ ÐÐ°Ð·Ð°Ð´ Ðº ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸ÑÐ¼", callback_data='back_to_categories'))
    bot.edit_message_text("ÐÑÐ±ÐµÑÐ¸ÑÐµ ÑÐ¾Ð²Ð°Ñ:", chat_id, message_id, reply_markup=markup)

def show_cart(chat_id, message_id=None):
    cart_items = db_query('''SELECT mi.id, mi.name, mi.price, c.quantity FROM cart c 
                             JOIN menu_items mi ON c.item_id = mi.id WHERE c.user_id = ?''', (chat_id,))
    text = "ð **ÐÐ°ÑÐ° ÐºÐ¾ÑÐ·Ð¸Ð½Ð°:**\n\n"
    markup = types.InlineKeyboardMarkup(row_width=1)
    if not cart_items:
        text = "ð ÐÐ°ÑÐ° ÐºÐ¾ÑÐ·Ð¸Ð½Ð° Ð¿ÑÑÑÐ°."
        markup.add(types.InlineKeyboardButton("â¬ï¸ Ð Ð¼ÐµÐ½Ñ", callback_data='back_to_categories'))
    else:
        total_price = sum(price * quantity for _, _, price, quantity in cart_items)
        for item_id, name, price, quantity in cart_items:
            text += f"âªï¸ {name} ({int(price)}Ñ) x {quantity} = {int(price * quantity)}Ñ\n"
            markup.add(types.InlineKeyboardButton(f"â Ð£Ð´Ð°Ð»Ð¸ÑÑ {name}", callback_data=f'remove:{item_id}'))
        text += f"\n**ÐÑÐ¾Ð³Ð¾: {int(total_price)} ÑÑÐ±.**"
        markup.add(types.InlineKeyboardButton("â ÐÑÐ¾ÑÐ¼Ð¸ÑÑ Ð·Ð°ÐºÐ°Ð·", callback_data='checkout'))
        markup.add(types.InlineKeyboardButton("ðï¸ ÐÑÐ¸ÑÑÐ¸ÑÑ ÐºÐ¾ÑÐ·Ð¸Ð½Ñ", callback_data='clear_cart'))
        markup.add(types.InlineKeyboardButton("â¬ï¸ ÐÑÐ¾Ð´Ð¾Ð»Ð¶Ð¸ÑÑ Ð¿Ð¾ÐºÑÐ¿ÐºÐ¸", callback_data='back_to_categories'))
    try:
        if message_id:
            bot.edit_message_text(text, chat_id, message_id, reply_markup=markup, parse_mode='Markdown')
        else:
            bot.send_message(chat_id, text, reply_markup=markup, parse_mode='Markdown')
    except telebot.apihelper.ApiTelegramException as e:
        if "message is not modified" not in str(e): print(f"Error editing cart message: {e}")

def confirm_order(chat_id, data):
    cart_items = db_query('''SELECT mi.name, mi.price, c.quantity FROM cart c JOIN menu_items mi 
                             ON c.item_id = mi.id WHERE c.user_id = ?''', (chat_id,))
    
    subtotal = sum(price * quantity for _, price, quantity in cart_items)
    settings = get_settings()
    delivery_cost = 0
    delivery_cost_text = ""

    if data['delivery_type'] == 'delivery':
        if subtotal < settings['free_delivery_threshold']:
            delivery_cost = settings['delivery_fee']
            delivery_cost_text = f"ð **ÐÐ¾ÑÑÐ°Ð²ÐºÐ°:** {int(delivery_cost)} ÑÑÐ±.\n"
        else:
            delivery_cost_text = f"ð **ÐÐ¾ÑÑÐ°Ð²ÐºÐ°:** ÐÐµÑÐ¿Ð»Ð°ÑÐ½Ð¾ (Ð·Ð°ÐºÐ°Ð· Ð¾Ñ {int(settings['free_delivery_threshold'])} ÑÑÐ±.)\n"

    final_total = subtotal + delivery_cost
    data['final_total'] = final_total

    delivery_text = 'Ð¡Ð°Ð¼Ð¾Ð²ÑÐ²Ð¾Ð·' if data['delivery_type'] == 'takeaway' else 'ÐÐ¾ÑÑÐ°Ð²ÐºÐ°'
    text = (f"ð **ÐÑÐ¾Ð²ÐµÑÑÑÐµ Ð²Ð°Ñ Ð·Ð°ÐºÐ°Ð·:**\n\n"
            f"ð¤ **ÐÐ¼Ñ:** {data['name']}\n"
            f"ð **Ð¢ÐµÐ»ÐµÑÐ¾Ð½:** {data['phone']}\n"
            f"**Ð¡Ð¿Ð¾ÑÐ¾Ð± Ð¿Ð¾Ð»ÑÑÐµÐ½Ð¸Ñ:** {delivery_text}\n")
    if data['delivery_type'] == 'delivery':
        text += f"ð **ÐÐ´ÑÐµÑ:** {data.get('address', 'ÐÐµ ÑÐºÐ°Ð·Ð°Ð½')}\n"
    if 'comment' in data:
        text += f"ð¬ **ÐÐ¾Ð¼Ð¼ÐµÐ½ÑÐ°ÑÐ¸Ð¹:** {data['comment']}\n"
    
    text += "\n**Ð¡Ð¾ÑÑÐ°Ð² Ð·Ð°ÐºÐ°Ð·Ð°:**\n" + "\n".join([f"âªï¸ {name} x {q} ÑÑ." for name, _, q in cart_items])
    text += f"\n\nð¦ **Ð¢Ð¾Ð²Ð°ÑÑ:** {int(subtotal)} ÑÑÐ±.\n"
    text += delivery_cost_text
    text += f"ð° **ÐÑÐ¾Ð³Ð¾ Ðº Ð¾Ð¿Ð»Ð°ÑÐµ: {int(final_total)} ÑÑÐ±.**\n\nÐÑÑ Ð²ÐµÑÐ½Ð¾?"
    
    set_user_state(chat_id, 'awaiting_final_confirmation', data)
    markup = types.InlineKeyboardMarkup(row_width=2).add(
        types.InlineKeyboardButton("â ÐÐ°, Ð¿Ð¾Ð´ÑÐ²ÐµÑÐ´Ð¸ÑÑ", callback_data='confirm_order'),
        types.InlineKeyboardButton("â ÐÑÐ¼ÐµÐ½Ð°", callback_data='cancel_order'))
    bot.send_message(chat_id, text, reply_markup=markup, parse_mode='Markdown')

def process_final_confirmation(chat_id):
    state, data = get_user_state(chat_id)
    if state != 'awaiting_final_confirmation' or not data:
        bot.send_message(chat_id, "Ð§ÑÐ¾-ÑÐ¾ Ð¿Ð¾ÑÐ»Ð¾ Ð½Ðµ ÑÐ°Ðº. ÐÐ¾Ð¶Ð°Ð»ÑÐ¹ÑÑÐ°, Ð¿Ð¾Ð¿ÑÐ¾Ð±ÑÐ¹ÑÐµ Ð¾ÑÐ¾ÑÐ¼Ð¸ÑÑ Ð·Ð°ÐºÐ°Ð· Ð·Ð°Ð½Ð¾Ð²Ð¾.", reply_markup=get_main_menu_keyboard())
        return

    cart_items = db_query('''SELECT mi.id, mi.name, mi.price, c.quantity FROM cart c 
                             JOIN menu_items mi ON c.item_id = mi.id WHERE c.user_id = ?''', (chat_id,))
    if not cart_items:
        bot.send_message(chat_id, "ÐÐ°ÑÐ° ÐºÐ¾ÑÐ·Ð¸Ð½Ð° Ð¿ÑÑÑÐ°. ÐÐ°ÐºÐ°Ð· Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ Ð±ÑÑÑ Ð¾ÑÐ¾ÑÐ¼Ð»ÐµÐ½.", reply_markup=get_main_menu_keyboard())
        clear_user_state(chat_id)
        return

    final_total = data.get('final_total', 0)

    delivery_text = 'Ð¡Ð°Ð¼Ð¾Ð²ÑÐ²Ð¾Ð·' if data['delivery_type'] == 'takeaway' else 'ÐÐ¾ÑÑÐ°Ð²ÐºÐ°'
    admin_text = (f"ð **ÐÐ¾Ð²ÑÐ¹ Ð·Ð°ÐºÐ°Ð·**\n\n"
                  f"**ÐÐ»Ð¸ÐµÐ½Ñ:** {data['name']}, {data['phone']}\n"
                  f"**Ð¢Ð¸Ð¿:** {delivery_text}\n")
    if data['delivery_type'] == 'delivery':
        admin_text += f"**ÐÐ´ÑÐµÑ:** {data.get('address', 'ÐÐµ ÑÐºÐ°Ð·Ð°Ð½')}\n"
    if 'comment' in data:
        admin_text += f"**ÐÐ¾Ð¼Ð¼ÐµÐ½ÑÐ°ÑÐ¸Ð¹:** {data['comment']}\n"
    admin_text += "\n**ÐÐ°ÐºÐ°Ð·:**\n" + "\n".join([f"âªï¸ {n} x {q} = {int(p * q)}Ñ" for _, n, p, q in cart_items])
    admin_text += f"\n\n**ÐÑÐ¾Ð³Ð¾ Ñ Ð´Ð¾ÑÑÐ°Ð²ÐºÐ¾Ð¹: {int(final_total)} ÑÑÐ±.**"
    
    notifications_sent = 0
    for admin_id in ADMIN_IDS:
        try:
            bot.send_message(admin_id, admin_text, parse_mode='Markdown')
            notifications_sent += 1
        except Exception as e:
            print(f"Failed to send message to admin {admin_id}: {e}")
    
    if notifications_sent == 0:
        print("CRITICAL: Failed to notify ANY admin.")
        bot.send_message(chat_id, "â ÐÑÐ¾Ð¸Ð·Ð¾ÑÐ»Ð° Ð¾ÑÐ¸Ð±ÐºÐ° Ð¿ÑÐ¸ Ð¾ÑÐ¾ÑÐ¼Ð»ÐµÐ½Ð¸Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°. ÐÑ Ð½Ðµ ÑÐ¼Ð¾Ð³Ð»Ð¸ ÑÐ²ÐµÐ´Ð¾Ð¼Ð¸ÑÑ Ð¿ÐµÑÑÐ¾Ð½Ð°Ð». ÐÐ¾Ð¶Ð°Ð»ÑÐ¹ÑÑÐ°, ÑÐ²ÑÐ¶Ð¸ÑÐµÑÑ Ñ Ð½Ð°Ð¼Ð¸ Ð¿Ð¾ ÑÐµÐ»ÐµÑÐ¾Ð½Ñ.", reply_markup=get_main_menu_keyboard())
        return
        
    conn = get_db_conn()
    cursor = conn.cursor()
    cursor.execute('''INSERT INTO orders (user_id, user_name, phone_number, delivery_type, address, comment, total_amount)
                      VALUES (?, ?, ?, ?, ?, ?, ?)''', (chat_id, data['name'], data['phone'], data['delivery_type'],
                      data.get('address', ''), data.get('comment', ''), final_total))
    order_id = cursor.lastrowid
    
    for admin_id in ADMIN_IDS:
        try: bot.send_message(admin_id, f"ÐÐ°ÐºÐ°Ð·Ñ Ð¿ÑÐ¸ÑÐ²Ð¾ÐµÐ½ Ð½Ð¾Ð¼ÐµÑ #{order_id}", parse_mode='Markdown')
        except: pass

    for _, name, price, quantity in cart_items:
        cursor.execute('INSERT INTO order_items (order_id, item_name, quantity, price_per_item) VALUES (?, ?, ?, ?)',
                       (order_id, name, quantity, price))
    conn.commit()

    bot.send_message(chat_id, f"â Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾! ÐÐ°Ñ Ð·Ð°ÐºÐ°Ð· #{order_id} Ð¿ÑÐ¸Ð½ÑÑ. ÐÑ ÑÐºÐ¾ÑÐ¾ Ñ Ð²Ð°Ð¼Ð¸ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ.", reply_markup=get_main_menu_keyboard())
    
    db_query("DELETE FROM cart WHERE user_id = ?", (chat_id,), commit=True)
    clear_user_state(chat_id)

def show_item_management_categories(chat_id, message_id):
    """ÐÑÐ¾Ð±ÑÐ°Ð¶Ð°ÐµÑ Ð¼ÐµÐ½Ñ ÑÐ¿ÑÐ°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð²Ð°ÑÐ°Ð¼Ð¸ Ñ ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼Ð¸ ÑÐ¿ÑÐ°Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸ÑÐ¼Ð¸."""
    categories = db_query("SELECT id, name FROM categories ORDER BY id")
    markup = types.InlineKeyboardMarkup(row_width=2)
    buttons = [types.InlineKeyboardButton(name, callback_data=f'admin_cat_items:{cat_id}') for cat_id, name in categories]
    markup.add(*buttons)
    # ÐÐ¾Ð²ÑÐµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÑÐ¿ÑÐ°Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸ÑÐ¼Ð¸
    markup.add(types.InlineKeyboardButton("â ÐÐ¾Ð±Ð°Ð²Ð¸ÑÑ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ñ", callback_data='admin_add_category'))
    markup.add(types.InlineKeyboardButton("â Ð£Ð´Ð°Ð»Ð¸ÑÑ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ñ", callback_data='admin_delete_category_menu'))
    
    markup.add(types.InlineKeyboardButton("â¬ï¸ ÐÐ°Ð·Ð°Ð´ Ð² Ð°Ð´Ð¼Ð¸Ð½-Ð¿Ð°Ð½ÐµÐ»Ñ", callback_data='admin:back_to_main'))
    bot.edit_message_text("ÐÐ°Ð¶Ð¼Ð¸ÑÐµ Ð½Ð° ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ñ Ð´Ð»Ñ ÑÐ¿ÑÐ°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð²Ð°ÑÐ°Ð¼Ð¸ Ð¸Ð»Ð¸ Ð²Ð¾ÑÐ¿Ð¾Ð»ÑÐ·ÑÐ¹ÑÐµÑÑ Ð¾Ð¿ÑÐ¸ÑÐ¼Ð¸ Ð½Ð¸Ð¶Ðµ:", chat_id, message_id, reply_markup=markup)

def show_categories_for_deletion(chat_id, message_id):
    """ÐÑÐ¾Ð±ÑÐ°Ð¶Ð°ÐµÑ ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ð¹ Ð´Ð»Ñ ÑÐ´Ð°Ð»ÐµÐ½Ð¸Ñ."""
    categories = db_query("SELECT id, name FROM categories ORDER BY id")
    markup = types.InlineKeyboardMarkup(row_width=1)
    if not categories:
        markup.add(types.InlineKeyboardButton("ÐÐµÑ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ð¹ Ð´Ð»Ñ ÑÐ´Ð°Ð»ÐµÐ½Ð¸Ñ.", callback_data='no_op'))
    else:
        for cat_id, name in categories:
            markup.add(types.InlineKeyboardButton(f"â {name}", callback_data=f'admin_select_cat_to_delete:{cat_id}'))
            
    markup.add(types.InlineKeyboardButton("â¬ï¸ ÐÐ°Ð·Ð°Ð´ Ðº ÑÐ¿ÑÐ°Ð²Ð»ÐµÐ½Ð¸Ñ", callback_data='admin:manage_items'))
    bot.edit_message_text("ÐÑÐ±ÐµÑÐ¸ÑÐµ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ñ Ð´Ð»Ñ ÑÐ´Ð°Ð»ÐµÐ½Ð¸Ñ. ÐÐÐÐÐÐÐÐ: ÑÑÐ¾ ÑÐ´Ð°Ð»Ð¸Ñ Ð²ÑÐµ ÑÐ¾Ð²Ð°ÑÑ Ð²Ð½ÑÑÑÐ¸ Ð½ÐµÐµ.", chat_id, message_id, reply_markup=markup)


def show_items_for_admin(chat_id, message_id, category_id):
    items = db_query("SELECT id, name, price FROM menu_items WHERE category_id = ?", (category_id,))
    markup = types.InlineKeyboardMarkup(row_width=1)
    for item_id, name, price in items:
        markup.add(types.InlineKeyboardButton(f"{name} - {int(price)}Ñ", callback_data=f'admin_edit_item:{item_id}'))
    markup.add(types.InlineKeyboardButton("â ÐÐ¾Ð±Ð°Ð²Ð¸ÑÑ Ð½Ð¾Ð²ÑÐ¹ ÑÐ¾Ð²Ð°Ñ", callback_data=f'admin_add_item:{category_id}'))
    markup.add(types.InlineKeyboardButton("â¬ï¸ ÐÐ°Ð·Ð°Ð´ Ðº ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸ÑÐ¼", callback_data='admin:manage_items'))
    bot.edit_message_text("ÐÐ°Ð¶Ð¼Ð¸ÑÐµ Ð½Ð° ÑÐ¾Ð²Ð°Ñ Ð´Ð»Ñ ÑÐµÐ´Ð°ÐºÑÐ¸ÑÐ¾Ð²Ð°Ð½Ð¸Ñ Ð¸Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²ÑÑÐµ Ð½Ð¾Ð²ÑÐ¹:", chat_id, message_id, reply_markup=markup)

def show_item_edit_menu(chat_id, message_id, item_id):
    item_name = db_query("SELECT name FROM menu_items WHERE id = ?", (item_id,), fetchone=True)[0]
    markup = types.InlineKeyboardMarkup(row_width=1)
    markup.add(types.InlineKeyboardButton("âï¸ ÐÐ·Ð¼ÐµÐ½Ð¸ÑÑ ÑÐµÐ½Ñ", callback_data=f'admin_price:{item_id}'))
    markup.add(types.InlineKeyboardButton("ðï¸ Ð£Ð´Ð°Ð»Ð¸ÑÑ ÑÐ¾Ð²Ð°Ñ", callback_data=f'admin_delete:{item_id}'))
    cat_id = db_query("SELECT category_id FROM menu_items WHERE id = ?", (item_id,), fetchone=True)[0]
    markup.add(types.InlineKeyboardButton("â¬ï¸ ÐÐ°Ð·Ð°Ð´ Ðº ÑÐ¾Ð²Ð°ÑÐ°Ð¼", callback_data=f'admin_cat_items:{cat_id}'))
    bot.edit_message_text(f"Ð ÐµÐ´Ð°ÐºÑÐ¸ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð²Ð°ÑÐ°: *{item_name}*", chat_id, message_id, reply_markup=markup, parse_mode='Markdown')

def show_admin_settings(chat_id, message_id):
    settings = get_settings()
    text = (f"âï¸ **ÐÐ°ÑÑÑÐ¾Ð¹ÐºÐ¸ Ð±Ð¾ÑÐ°**\n\n"
            f"ð **Ð¡ÑÐ¾Ð¸Ð¼Ð¾ÑÑÑ Ð´Ð¾ÑÑÐ°Ð²ÐºÐ¸:** {int(settings.get('delivery_fee', 0))} ÑÑÐ±.\n"
            f"ð **ÐÐµÑÐ¿Ð»Ð°ÑÐ½Ð°Ñ Ð´Ð¾ÑÑÐ°Ð²ÐºÐ° Ð¾Ñ:** {int(settings.get('free_delivery_threshold', 0))} ÑÑÐ±.")
    
    markup = types.InlineKeyboardMarkup(row_width=1)
    markup.add(types.InlineKeyboardButton("âï¸ ÐÐ·Ð¼ÐµÐ½Ð¸ÑÑ ÑÑÐ¾Ð¸Ð¼Ð¾ÑÑÑ Ð´Ð¾ÑÑÐ°Ð²ÐºÐ¸", callback_data='admin_edit_setting:delivery_fee'))
    markup.add(types.InlineKeyboardButton("âï¸ ÐÐ·Ð¼ÐµÐ½Ð¸ÑÑ Ð¿Ð¾ÑÐ¾Ð³ Ð±ÐµÑÐ¿Ð»Ð°ÑÐ½Ð¾Ð¹ Ð´Ð¾ÑÑÐ°Ð²ÐºÐ¸", callback_data='admin_edit_setting:free_delivery_threshold'))
    markup.add(types.InlineKeyboardButton("â¬ï¸ ÐÐ°Ð·Ð°Ð´ Ð² Ð°Ð´Ð¼Ð¸Ð½-Ð¿Ð°Ð½ÐµÐ»Ñ", callback_data='admin:back_to_main'))
    bot.edit_message_text(text, chat_id, message_id, reply_markup=markup, parse_mode='Markdown')


# --- 6. MESSAGE HANDLERS (CORRECT ORDER) ---

@bot.message_handler(commands=['start'])
def send_welcome(message):
    clear_user_state(message.chat.id)
    bot.send_message(message.chat.id, "ð ÐÐ´ÑÐ°Ð²ÑÑÐ²ÑÐ¹ÑÐµ! ÐÐ¾Ð±ÑÐ¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°ÑÑ Ð² Street-eda.", reply_markup=get_main_menu_keyboard())

@bot.message_handler(commands=['admin'])
def admin_panel(message):
    if message.from_user.id not in ADMIN_IDS: return
    clear_user_state(message.chat.id)
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("Ð£Ð¿ÑÐ°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¾Ð²Ð°ÑÐ°Ð¼Ð¸", callback_data='admin:manage_items'))
    markup.add(types.InlineKeyboardButton("âï¸ ÐÐ°ÑÑÑÐ¾Ð¹ÐºÐ¸", callback_data='admin:settings'))
    bot.send_message(message.chat.id, "ÐÐ¾Ð±ÑÐ¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°ÑÑ Ð² Ð¿Ð°Ð½ÐµÐ»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑÑÐ°ÑÐ¾ÑÐ°.", reply_markup=markup)

@bot.message_handler(func=lambda message: message.text == "ð´ ÐÐµÐ½Ñ")
def show_menu(message):
    clear_user_state(message.chat.id)
    show_categories(message.chat.id)

@bot.message_handler(content_types=['text', 'contact'])
def handle_stateful_messages(message):
    user_id = message.from_user.id
    state, data = get_user_state(user_id)
    if not state: return

    # --- User States ---
    if state == 'awaiting_name':
        data['name'] = message.text
        bot.send_message(user_id, "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾! Ð¢ÐµÐ¿ÐµÑÑ Ð¾ÑÐ¿ÑÐ°Ð²ÑÑÐµ Ð²Ð°Ñ Ð½Ð¾Ð¼ÐµÑ ÑÐµÐ»ÐµÑÐ¾Ð½Ð°.", reply_markup=types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True).add(types.KeyboardButton("ð± ÐÑÐ¿ÑÐ°Ð²Ð¸ÑÑ Ð¼Ð¾Ð¹ ÐºÐ¾Ð½ÑÐ°ÐºÑ", request_contact=True)))
        set_user_state(user_id, 'awaiting_phone', data)
    elif state == 'awaiting_phone':
        phone = message.contact.phone_number if message.contact else (message.text if 10 <= len(re.sub(r'\D', '', message.text)) <= 15 else None)
        if phone:
            data['phone'] = phone
            bot.send_message(user_id, "ÐÐ°Ñ Ð½Ð¾Ð¼ÐµÑ Ð¿ÑÐ¸Ð½ÑÑ.", reply_markup=types.ReplyKeyboardRemove())
            markup = types.InlineKeyboardMarkup(row_width=2).add(types.InlineKeyboardButton("ð Ð¡Ð°Ð¼Ð¾Ð²ÑÐ²Ð¾Ð·", callback_data='delivery:takeaway'), types.InlineKeyboardButton("ð ÐÐ¾ÑÑÐ°Ð²ÐºÐ°", callback_data='delivery:delivery'))
            bot.send_message(user_id, "ÐÑÐ±ÐµÑÐ¸ÑÐµ ÑÐ¿Ð¾ÑÐ¾Ð± Ð¿Ð¾Ð»ÑÑÐµÐ½Ð¸Ñ:", reply_markup=markup)
            set_user_state(user_id, 'awaiting_delivery_choice', data)
        else:
            bot.send_message(user_id, "â ÐÐµÐ²ÐµÑÐ½ÑÐ¹ ÑÐ¾ÑÐ¼Ð°Ñ Ð½Ð¾Ð¼ÐµÑÐ°. ÐÐ¾Ð¶Ð°Ð»ÑÐ¹ÑÑÐ°, Ð¾ÑÐ¿ÑÐ°Ð²ÑÑÐµ ÐºÐ¾Ð½ÑÐ°ÐºÑ Ð¸Ð»Ð¸ Ð²Ð²ÐµÐ´Ð¸ÑÐµ Ð½Ð¾Ð¼ÐµÑ.")
    elif state == 'awaiting_address':
        if message.text and len(message.text) > 5:
            data['address'] = message.text
            bot.send_message(user_id, "ÐÑÑÑ Ð»Ð¸ ÐºÐ¾Ð¼Ð¼ÐµÐ½ÑÐ°ÑÐ¸Ð¹ Ðº Ð·Ð°ÐºÐ°Ð·Ñ? ÐÑÐ»Ð¸ Ð½ÐµÑ, Ð½Ð°Ð¿Ð¸ÑÐ¸ÑÐµ 'Ð½ÐµÑ'.")
            set_user_state(user_id, 'awaiting_comment', data)
        else:
            bot.send_message(user_id, "â ÐÐ´ÑÐµÑ ÑÐ»Ð¸ÑÐºÐ¾Ð¼ ÐºÐ¾ÑÐ¾ÑÐºÐ¸Ð¹. ÐÐ¾Ð¶Ð°Ð»ÑÐ¹ÑÑÐ°, Ð²Ð²ÐµÐ´Ð¸ÑÐµ Ð¿Ð¾Ð»Ð½ÑÐ¹ Ð°Ð´ÑÐµÑ.")
    elif state == 'awaiting_comment':
        if message.text.lower().strip() not in ['Ð½ÐµÑ', 'no', '-']:
            data['comment'] = message.text
        clear_user_state(user_id)
        confirm_order(user_id, data)

    # --- Admin States ---
    elif state == 'admin_awaiting_item_name':
        data['name'] = message.text
        bot.send_message(user_id, "ÐÑÐ»Ð¸ÑÐ½Ð¾. Ð¢ÐµÐ¿ÐµÑÑ Ð²Ð²ÐµÐ´Ð¸ÑÐµ ÑÐµÐ½Ñ ÑÐ¾Ð²Ð°ÑÐ° (ÑÐ¾Ð»ÑÐºÐ¾ ÑÐ¸ÑÑÑ):")
        set_user_state(user_id, 'admin_awaiting_item_price', data)
    elif state == 'admin_awaiting_item_price':
        try:
            price = float(message.text)
            db_query("INSERT INTO menu_items (name, price, description, category_id) VALUES (?, ?, ?, ?)", (data['name'], price, None, data['category_id']), commit=True)
            bot.send_message(user_id, f"â Ð¢Ð¾Ð²Ð°Ñ '{data['name']}' ÑÑÐ¿ÐµÑÐ½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½!")
            clear_user_state(user_id)
            admin_panel(message) # ÐÐ¾Ð·Ð²ÑÐ°ÑÐ°ÐµÐ¼ Ð² Ð°Ð´Ð¼Ð¸Ð½-Ð¼ÐµÐ½Ñ
        except ValueError:
            bot.send_message(user_id, "ÐÑÐ¸Ð±ÐºÐ°: ÑÐµÐ½Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±ÑÑÑ ÑÐ¸ÑÐ»Ð¾Ð¼. ÐÐ¾Ð¿ÑÐ¾Ð±ÑÐ¹ÑÐµ ÑÐ½Ð¾Ð²Ð°.")
    elif state == 'admin_awaiting_new_price':
        try:
            new_price = float(message.text)
            db_query("UPDATE menu_items SET price = ? WHERE id = ?", (new_price, data['item_id']), commit=True)
            bot.send_message(user_id, f"â Ð¦ÐµÐ½Ð° ÑÑÐ¿ÐµÑÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð´Ð¾ {int(new_price)} ÑÑÐ±.")
            clear_user_state(user_id)
            admin_panel(message) # ÐÐ¾Ð·Ð²ÑÐ°ÑÐ°ÐµÐ¼ Ð² Ð°Ð´Ð¼Ð¸Ð½-Ð¼ÐµÐ½Ñ
        except ValueError:
            bot.send_message(user_id, "ÐÑÐ¸Ð±ÐºÐ°: ÑÐµÐ½Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±ÑÑÑ ÑÐ¸ÑÐ»Ð¾Ð¼. ÐÐ¾Ð¿ÑÐ¾Ð±ÑÐ¹ÑÐµ ÑÐ½Ð¾Ð²Ð°.")
    elif state == 'admin_awaiting_new_setting':
        try:
            new_value = float(message.text)
            setting_key = data['key']
            db_query("UPDATE settings SET value = ? WHERE key = ?", (new_value, setting_key), commit=True)
            bot.send_message(user_id, "â ÐÐ°ÑÑÑÐ¾Ð¹ÐºÐ° ÑÑÐ¿ÐµÑÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°!")
            clear_user_state(user_id)
            admin_panel(message) # ÐÐ¾Ð·Ð²ÑÐ°ÑÐ°ÐµÐ¼ Ð² Ð°Ð´Ð¼Ð¸Ð½-Ð¼ÐµÐ½Ñ
        except ValueError:
            bot.send_message(user_id, "ÐÑÐ¸Ð±ÐºÐ°: Ð²Ð²ÐµÐ´Ð¸ÑÐµ ÑÐ¾Ð»ÑÐºÐ¾ ÑÐ¸ÑÐ»Ð¾. ÐÐ¾Ð¿ÑÐ¾Ð±ÑÐ¹ÑÐµ ÑÐ½Ð¾Ð²Ð°.")
    elif state == 'admin_awaiting_new_category_name':
        cat_name = message.text.strip()
        if not cat_name:
            bot.send_message(user_id, "ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ð¸ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ Ð±ÑÑÑ Ð¿ÑÑÑÑÐ¼. ÐÐ¾Ð¿ÑÐ¾Ð±ÑÐ¹ÑÐµ ÑÐ½Ð¾Ð²Ð°.")
            return
        
        exists = db_query("SELECT id FROM categories WHERE name = ?", (cat_name,), fetchone=True)
        if exists:
            bot.send_message(user_id, "â ÐÐ°ÑÐµÐ³Ð¾ÑÐ¸Ñ Ñ ÑÐ°ÐºÐ¸Ð¼ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÐµÐ¼ ÑÐ¶Ðµ ÑÑÑÐµÑÑÐ²ÑÐµÑ. ÐÐ¾Ð¿ÑÐ¾Ð±ÑÐ¹ÑÐµ Ð´ÑÑÐ³Ð¾Ðµ.")
            return
        
        db_query("INSERT INTO categories (name) VALUES (?)", (cat_name,), commit=True)
        bot.send_message(user_id, f"â ÐÐ°ÑÐµÐ³Ð¾ÑÐ¸Ñ '{cat_name}' ÑÑÐ¿ÐµÑÐ½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð°.")
        clear_user_state(user_id)
        admin_panel(message) # ÐÐ¾Ð·Ð²ÑÐ°ÑÐ°ÐµÐ¼ Ð² Ð°Ð´Ð¼Ð¸Ð½-Ð¼ÐµÐ½Ñ


# --- 7. MAIN CALLBACK HANDLER ---
@bot.callback_query_handler(func=lambda call: True)
def handle_callback_query(call):
    chat_id = call.message.chat.id
    message_id = call.message.message_id
    prefix, _, value = call.data.partition(':')
    
    # --- User Callbacks ---
    if prefix == 'category':
        show_items_in_category(chat_id, message_id, int(value))
    elif prefix == 'item':
        item_id = int(value)
        db_query("INSERT OR REPLACE INTO cart (user_id, item_id, quantity) VALUES (?, ?, COALESCE((SELECT quantity FROM cart WHERE user_id = ? AND item_id = ?), 0) + 1)", (chat_id, item_id, chat_id, item_id), commit=True)
        bot.answer_callback_query(call.id, "â ÐÐ¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ð² ÐºÐ¾ÑÐ·Ð¸Ð½Ñ!")
    elif prefix == 'back_to_categories':
        show_categories(chat_id, message_id)
    elif prefix == 'view_cart':
        show_cart(chat_id, message_id)
    elif prefix == 'remove':
        db_query("DELETE FROM cart WHERE user_id = ? AND item_id = ?", (chat_id, int(value)), commit=True)
        bot.answer_callback_query(call.id, "ðï¸ Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ Ð¸Ð· ÐºÐ¾ÑÐ·Ð¸Ð½Ñ")
        show_cart(chat_id, message_id)
    elif prefix == 'clear_cart':
        db_query("DELETE FROM cart WHERE user_id = ?", (chat_id,), commit=True)
        bot.answer_callback_query(call.id, "ðï¸ ÐÐ¾ÑÐ·Ð¸Ð½Ð° Ð¾ÑÐ¸ÑÐµÐ½Ð°")
        show_categories(chat_id, message_id)
    elif prefix == 'checkout':
        if not db_query("SELECT 1 FROM cart WHERE user_id = ?", (chat_id,), fetchone=True):
            bot.answer_callback_query(call.id, "ÐÐ°ÑÐ° ÐºÐ¾ÑÐ·Ð¸Ð½Ð° Ð¿ÑÑÑÐ°!", show_alert=True)
            return
        bot.send_message(chat_id, "ð ÐÐ²ÐµÐ´Ð¸ÑÐµ Ð²Ð°ÑÐµ Ð¸Ð¼Ñ:")
        set_user_state(chat_id, 'awaiting_name', {})
    elif prefix == 'delivery':
        state, data = get_user_state(chat_id)
        if state == 'awaiting_delivery_choice':
            data['delivery_type'] = value
            bot.delete_message(chat_id, message_id)
            if value == 'delivery':
                bot.send_message(chat_id, "ð ÐÐ¾Ð¶Ð°Ð»ÑÐ¹ÑÑÐ°, Ð²Ð²ÐµÐ´Ð¸ÑÐµ Ð²Ð°Ñ Ð°Ð´ÑÐµÑ:")
                set_user_state(chat_id, 'awaiting_address', data)
            else:
                bot.send_message(chat_id, "ÐÑÑÑ Ð»Ð¸ ÐºÐ¾Ð¼Ð¼ÐµÐ½ÑÐ°ÑÐ¸Ð¹ Ðº Ð·Ð°ÐºÐ°Ð·Ñ? ÐÑÐ»Ð¸ Ð½ÐµÑ, Ð½Ð°Ð¿Ð¸ÑÐ¸ÑÐµ 'Ð½ÐµÑ'.")
                set_user_state(chat_id, 'awaiting_comment', data)
    elif prefix == 'confirm_order':
        process_final_confirmation(chat_id)
        bot.delete_message(chat_id, message_id)
    elif prefix == 'cancel_order':
        clear_user_state(chat_id)
        bot.edit_message_text("â ÐÐ°ÐºÐ°Ð· Ð¾ÑÐ¼ÐµÐ½ÐµÐ½.", chat_id, message_id, reply_markup=None)
        bot.send_message(chat_id, "ÐÑ Ð¼Ð¾Ð¶ÐµÑÐµ Ð¿ÑÐ¾Ð´Ð¾Ð»Ð¶Ð¸ÑÑ Ð¿ÑÐ¾ÑÐ¼Ð¾ÑÑ Ð¼ÐµÐ½Ñ.", reply_markup=get_main_menu_keyboard())

    # --- Admin Callbacks ---
    elif prefix == 'admin':
        if chat_id not in ADMIN_IDS: return
        if value == 'manage_items': show_item_management_categories(chat_id, message_id)
        elif value == 'settings': show_admin_settings(chat_id, message_id)
        elif value == 'back_to_main':
            markup = types.InlineKeyboardMarkup()
            markup.add(types.InlineKeyboardButton("Ð£Ð¿ÑÐ°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¾Ð²Ð°ÑÐ°Ð¼Ð¸", callback_data='admin:manage_items'))
            markup.add(types.InlineKeyboardButton("âï¸ ÐÐ°ÑÑÑÐ¾Ð¹ÐºÐ¸", callback_data='admin:settings'))
            bot.edit_message_text("ÐÐ¾Ð±ÑÐ¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°ÑÑ Ð² Ð¿Ð°Ð½ÐµÐ»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑÑÐ°ÑÐ¾ÑÐ°.", chat_id, message_id, reply_markup=markup)
    
    # --- Category Management Callbacks ---
    elif prefix == 'admin_add_category':
        if chat_id not in ADMIN_IDS: return
        bot.answer_callback_query(call.id)
        bot.send_message(chat_id, "ÐÐ²ÐµÐ´Ð¸ÑÐµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð¹ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ð¸:")
        set_user_state(chat_id, 'admin_awaiting_new_category_name')

    elif prefix == 'admin_delete_category_menu':
        if chat_id not in ADMIN_IDS: return
        show_categories_for_deletion(chat_id, message_id)
        
    elif prefix == 'admin_select_cat_to_delete':
        if chat_id not in ADMIN_IDS: return
        cat_id = int(value)
        cat_name_result = db_query("SELECT name FROM categories WHERE id = ?", (cat_id,), fetchone=True)
        if not cat_name_result:
             bot.answer_callback_query(call.id, "ÐÐ°ÑÐµÐ³Ð¾ÑÐ¸Ñ ÑÐ¶Ðµ ÑÐ´Ð°Ð»ÐµÐ½Ð°.", show_alert=True)
             show_categories_for_deletion(chat_id, message_id)
             return
        cat_name = cat_name_result[0]
        markup = types.InlineKeyboardMarkup(row_width=2)
        markup.add(
            types.InlineKeyboardButton("â ÐÐ°, ÑÐ´Ð°Ð»Ð¸ÑÑ", callback_data=f'admin_confirm_delete_cat:{cat_id}'),
            types.InlineKeyboardButton("â ÐÑÐ¼ÐµÐ½Ð°", callback_data='admin_delete_category_menu')
        )
        bot.edit_message_text(f"ÐÑ ÑÐ²ÐµÑÐµÐ½Ñ, ÑÑÐ¾ ÑÐ¾ÑÐ¸ÑÐµ ÑÐ´Ð°Ð»Ð¸ÑÑ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ñ '{cat_name}'?\n\nâ¼ï¸ *ÐÐ¡Ð Ð¢ÐÐÐÐ Ð«* Ð² ÑÑÐ¾Ð¹ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ð¸ Ð±ÑÐ´ÑÑ Ð±ÐµÐ·Ð²Ð¾Ð·Ð²ÑÐ°ÑÐ½Ð¾ ÑÐ´Ð°Ð»ÐµÐ½Ñ!", chat_id, message_id, reply_markup=markup, parse_mode='Markdown')

    elif prefix == 'admin_confirm_delete_cat':
        if chat_id not in ADMIN_IDS: return
        cat_id = int(value)
        # 1. Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ²ÑÐ·Ð°Ð½Ð½ÑÐµ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¸Ð· ÐºÐ¾ÑÐ·Ð¸Ð½ Ð¿Ð¾Ð»ÑÐ·Ð¾Ð²Ð°ÑÐµÐ»ÐµÐ¹
        db_query("DELETE FROM cart WHERE item_id IN (SELECT id FROM menu_items WHERE category_id = ?)", (cat_id,), commit=True)
        # 2. Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ ÑÐ¾Ð²Ð°ÑÑ Ð² ÑÑÐ¾Ð¹ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ð¸
        db_query("DELETE FROM menu_items WHERE category_id = ?", (cat_id,), commit=True)
        # 3. Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ°Ð¼Ñ ÐºÐ°ÑÐµÐ³Ð¾ÑÐ¸Ñ
        db_query("DELETE FROM categories WHERE id = ?", (cat_id,), commit=True)
        bot.answer_callback_query(call.id, "ðï¸ ÐÐ°ÑÐµÐ³Ð¾ÑÐ¸Ñ Ð¸ Ð²ÑÐµ ÑÐ¾Ð²Ð°ÑÑ Ð² Ð½ÐµÐ¹ ÑÐ´Ð°Ð»ÐµÐ½Ñ.")
        # ÐÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð´Ð»Ñ ÑÐ´Ð°Ð»ÐµÐ½Ð¸Ñ
        show_categories_for_deletion(chat_id, message_id)
        
    # --- Item Management Callbacks ---
    elif prefix == 'admin_cat_items':
        if chat_id not in ADMIN_IDS: return
        show_items_for_admin(chat_id, message_id, int(value))
    elif prefix == 'admin_edit_item':
        if chat_id not in ADMIN_IDS: return
        show_item_edit_menu(chat_id, message_id, int(value))
    elif prefix == 'admin_add_item':
        if chat_id not in ADMIN_IDS: return
        bot.send_message(chat_id, "ÐÐ²ÐµÐ´Ð¸ÑÐµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð²Ð°ÑÐ°:")
        set_user_state(chat_id, 'admin_awaiting_item_name', {'category_id': int(value)})
    elif prefix == 'admin_price':
        if chat_id not in ADMIN_IDS: return
        bot.send_message(chat_id, "ÐÐ²ÐµÐ´Ð¸ÑÐµ Ð½Ð¾Ð²ÑÑ ÑÐµÐ½Ñ ÑÐ¾Ð²Ð°ÑÐ°:")
        set_user_state(chat_id, 'admin_awaiting_new_price', {'item_id': int(value)})
    elif prefix == 'admin_edit_setting':
        if chat_id not in ADMIN_IDS: return
        prompt_text = "ÐÐ²ÐµÐ´Ð¸ÑÐµ Ð½Ð¾Ð²ÑÑ ÑÑÐ¾Ð¸Ð¼Ð¾ÑÑÑ Ð´Ð¾ÑÑÐ°Ð²ÐºÐ¸:" if value == "delivery_fee" else "ÐÐ²ÐµÐ´Ð¸ÑÐµ Ð½Ð¾Ð²ÑÐ¹ Ð¿Ð¾ÑÐ¾Ð³ Ð´Ð»Ñ Ð±ÐµÑÐ¿Ð»Ð°ÑÐ½Ð¾Ð¹ Ð´Ð¾ÑÑÐ°Ð²ÐºÐ¸:"
        bot.send_message(chat_id, prompt_text)
        set_user_state(chat_id, 'admin_awaiting_new_setting', {'key': value})
    elif prefix == 'admin_delete':
        if chat_id not in ADMIN_IDS: return
        item_id = int(value)
        markup = types.InlineKeyboardMarkup(row_width=2).add(types.InlineKeyboardButton("â ÐÐ°, ÑÐ´Ð°Ð»Ð¸ÑÑ", callback_data=f'admin_confirm_delete:{item_id}'), types.InlineKeyboardButton("â ÐÐµÑ, Ð¾ÑÐ¼ÐµÐ½Ð°", callback_data=f'admin_edit_item:{item_id}'))
        bot.edit_message_text("ÐÑ ÑÐ²ÐµÑÐµÐ½Ñ, ÑÑÐ¾ ÑÐ¾ÑÐ¸ÑÐµ ÑÐ´Ð°Ð»Ð¸ÑÑ ÑÑÐ¾Ñ ÑÐ¾Ð²Ð°Ñ?", chat_id, message_id, reply_markup=markup)
    elif prefix == 'admin_confirm_delete':
        if chat_id not in ADMIN_IDS: return
        item_id = int(value)
        cat_id_result = db_query("SELECT category_id FROM menu_items WHERE id = ?", (item_id,), fetchone=True)
        if cat_id_result:
            cat_id = cat_id_result[0]
            db_query("DELETE FROM cart WHERE item_id = ?", (item_id,), commit=True)
            db_query("DELETE FROM menu_items WHERE id = ?", (item_id,), commit=True)
            bot.answer_callback_query(call.id, "Ð¢Ð¾Ð²Ð°Ñ ÑÐ´Ð°Ð»ÐµÐ½.")
            show_items_for_admin(chat_id, message_id, cat_id)
        else:
            bot.answer_callback_query(call.id, "â ÐÑÐ¸Ð±ÐºÐ°: ÑÐ¾Ð²Ð°Ñ ÑÐ¶Ðµ ÑÐ´Ð°Ð»ÐµÐ½.", show_alert=True)
            show_item_management_categories(chat_id, message_id)

# --- 8. START POLLING ---
if __name__ == '__main__':
    print("Bot is starting...")
    bot.polling(none_stop=True)